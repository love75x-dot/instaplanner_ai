<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insta Feed Master 5.0 - High-Res Edition</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

    <style>
        * {
            font-family: 'Pretendard', 'Inter', sans-serif;
        }

        .instagram-gradient {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }

        .iphone-frame {
            width: 375px;
            background: #000;
            border-radius: 40px;
            padding: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .iphone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 210px;
            height: 30px;
            background: #000;
            border-radius: 0 0 20px 20px;
            z-index: 10;
        }

        .iphone-screen {
            width: 100%;
            background: #fff;
            border-radius: 32px;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 750px;
        }

        /* High-Res Canvas Display */
        #editCanvas {
            max-width: 100%;
            height: auto;
            display: block;
            background: #000;
        }

        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s;
            z-index: 10;
        }

        .carousel-container:hover .carousel-arrow {
            opacity: 1;
        }

        .carousel-arrow:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .carousel-arrow.prev {
            left: 10px;
        }

        .carousel-arrow.next {
            right: 10px;
        }

        .carousel-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .dot-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #dbdbdb;
            transition: all 0.3s;
        }

        .dot-indicator.active {
            background: #0095f6;
        }

        .position-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }

        .position-cell {
            aspect-ratio: 1;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .position-cell:hover {
            border-color: #dc2743;
            background: rgba(220, 39, 67, 0.05);
        }

        .position-cell.active {
            border-color: #dc2743;
            background: rgba(220, 39, 67, 0.1);
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-left-color: #dc2743;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .drag-area {
            border: 2px dashed #d1d5db;
            transition: all 0.3s;
        }

        .drag-area.dragover {
            border-color: #dc2743;
            background: rgba(220, 39, 67, 0.05);
        }

        .image-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .image-thumbnail:hover {
            border-color: #dc2743;
        }

        .image-thumbnail.active {
            border-color: #dc2743;
            box-shadow: 0 0 0 2px rgba(220, 39, 67, 0.2);
        }

        /* Sticky Preview Panel */
        .preview-panel {
            position: sticky;
            top: 20px;
            align-self: flex-start;
        }

        @media (max-width: 1024px) {
            .preview-panel {
                position: relative;
                top: 0;
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="instagram-gradient w-12 h-12 rounded-2xl flex items-center justify-center">
                        <i class="fab fa-instagram text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Insta Feed Master 5.0</h1>
                        <p class="text-sm text-gray-500">High-Res Edition</p>
                    </div>
                </div>
                <button onclick="openSettings()" class="p-3 rounded-xl hover:bg-gray-100 transition">
                    <i class="fas fa-cog text-gray-600 text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Left Panel: Editing Controls -->
            <div class="space-y-6">

                <!-- Image Upload -->
                <div class="bg-white rounded-3xl shadow-lg p-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">
                        <i class="fas fa-images mr-2 text-pink-500"></i>
                        ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìµœëŒ€ 10ì¥)
                    </h2>
                    <div id="dropArea"
                        class="drag-area rounded-2xl p-12 text-center cursor-pointer bg-gray-50 hover:bg-gray-100 transition mb-4">
                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600 font-medium mb-2">ì—¬ëŸ¬ ì‚¬ì§„ì„ í•œ ë²ˆì— ë†“ìœ¼ì„¸ìš”</p>
                        <p class="text-sm text-gray-400">ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ (ìµœëŒ€ 10ì¥)</p>
                        <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
                    </div>

                    <!-- Image Thumbnails -->
                    <div id="imageThumbnails" class="flex flex-wrap gap-2 hidden">
                        <!-- Thumbnails will be inserted here -->
                    </div>
                </div>

                <!-- Aspect Ratio -->
                <div class="bg-white rounded-3xl shadow-lg p-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">
                        <i class="fas fa-crop mr-2 text-purple-500"></i>
                        ë¹„ìœ¨ ì„ íƒ
                    </h2>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setAspectRatio('1:1')" id="ratio-1-1"
                            class="aspect-ratio-btn border-2 border-pink-500 bg-pink-50 rounded-xl p-4 font-medium transition">
                            1:1<br><span class="text-sm text-gray-500">ì •ì‚¬ê°í˜•</span>
                        </button>
                        <button onclick="setAspectRatio('4:5')" id="ratio-4-5"
                            class="aspect-ratio-btn border-2 border-gray-200 rounded-xl p-4 font-medium transition hover:border-pink-500">
                            4:5<br><span class="text-sm text-gray-500">ì„¸ë¡œ</span>
                        </button>
                        <button onclick="setAspectRatio('original')" id="ratio-original"
                            class="aspect-ratio-btn border-2 border-gray-200 rounded-xl p-4 font-medium transition hover:border-pink-500">
                            ì›ë³¸<br><span class="text-sm text-gray-500">Original</span>
                        </button>
                    </div>
                </div>

                <!-- Logo Studio (Moved to Top!) -->
                <div class="bg-white rounded-3xl shadow-lg p-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">
                        <i class="fas fa-stamp mr-2 text-blue-500"></i>
                        ë¡œê³  ìŠ¤íŠœë””ì˜¤
                    </h2>

                    <!-- Logo Upload -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë¡œê³  ì´ë¯¸ì§€</label>
                        <input type="file" id="logoInput" accept="image/*"
                            class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 text-sm">
                    </div>

                    <!-- Position Grid -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìœ„ì¹˜ ì„ íƒ</label>
                        <div class="position-grid">
                            <div class="position-cell" data-position="top-left" onclick="setLogoPosition('top-left')">
                            </div>
                            <div class="position-cell" data-position="top-center"
                                onclick="setLogoPosition('top-center')"></div>
                            <div class="position-cell" data-position="top-right" onclick="setLogoPosition('top-right')">
                            </div>
                            <div class="position-cell" data-position="middle-left"
                                onclick="setLogoPosition('middle-left')"></div>
                            <div class="position-cell" data-position="middle-center"
                                onclick="setLogoPosition('middle-center')"></div>
                            <div class="position-cell" data-position="middle-right"
                                onclick="setLogoPosition('middle-right')"></div>
                            <div class="position-cell active" data-position="bottom-left"
                                onclick="setLogoPosition('bottom-left')"></div>
                            <div class="position-cell" data-position="bottom-center"
                                onclick="setLogoPosition('bottom-center')"></div>
                            <div class="position-cell" data-position="bottom-right"
                                onclick="setLogoPosition('bottom-right')"></div>
                        </div>
                    </div>

                    <!-- Size Slider -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">í¬ê¸°: <span
                                id="logoSizeValue">20</span>%</label>
                        <input type="range" id="logoSize" min="1" max="50" value="20" class="w-full"
                            oninput="updateLogoSize(this.value)">
                    </div>

                    <!-- Margin Slider (NEW!) -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì—¬ë°±: <span
                                id="logoMarginValue">3</span>%</label>
                        <input type="range" id="logoMargin" min="0" max="10" value="3" class="w-full"
                            oninput="updateLogoMargin(this.value)">
                    </div>

                    <!-- Opacity Slider -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">íˆ¬ëª…ë„: <span
                                id="logoOpacityValue">80</span>%</label>
                        <input type="range" id="logoOpacity" min="0" max="100" value="80" class="w-full"
                            oninput="updateLogoOpacity(this.value)">
                    </div>
                </div>

                <!-- Generate Button -->
                <button onclick="generateCaption()"
                    class="w-full instagram-gradient text-white font-semibold py-4 rounded-2xl shadow-lg flex items-center justify-center space-x-2 hover:shadow-xl transition">
                    <i class="fas fa-magic"></i>
                    <span>âœ¨ AI ìº¡ì…˜ ìƒì„±í•˜ê¸°</span>
                </button>

                <!-- Download Button -->
                <button onclick="downloadCurrentImage()" id="downloadBtn"
                    class="hidden w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white font-semibold py-4 rounded-2xl shadow-lg flex items-center justify-center space-x-2 hover:shadow-xl transition">
                    <i class="fas fa-download"></i>
                    <span>í˜„ì¬ ì´ë¯¸ì§€ ê³ í™”ì§ˆ ë‹¤ìš´ë¡œë“œ</span>
                </button>

            </div>

            <!-- Right Panel: iPhone Mockup (STICKY!) -->
            <div class="preview-panel">
                <div class="iphone-frame relative mx-auto">
                    <div class="iphone-notch"></div>
                    <div class="iphone-screen">

                        <!-- Instagram Header -->
                        <div class="p-3 border-b border-gray-200 flex items-center justify-between bg-white">
                            <div class="flex items-center space-x-3">
                                <div class="instagram-gradient w-10 h-10 rounded-full flex items-center justify-center">
                                    <i class="fab fa-instagram text-white text-sm"></i>
                                </div>
                                <span class="font-semibold text-sm">InstaPlanner</span>
                            </div>
                            <i class="fas fa-ellipsis-v text-gray-600"></i>
                        </div>

                        <!-- Carousel Image Area -->
                        <div class="relative carousel-container bg-black">
                            <canvas id="editCanvas"></canvas>

                            <!-- Navigation Arrows -->
                            <button class="carousel-arrow prev" id="prevBtn" onclick="prevImage()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="carousel-arrow next" id="nextBtn" onclick="nextImage()">
                                <i class="fas fa-chevron-right"></i>
                            </button>

                            <!-- Dot Indicators -->
                            <div id="dotIndicators"
                                class="absolute bottom-2 left-0 right-0 flex items-center justify-center gap-1">
                                <!-- Dots will be inserted here -->
                            </div>
                        </div>

                        <!-- Interaction Icons -->
                        <div class="p-3 flex items-center justify-between bg-white">
                            <div class="flex items-center space-x-4">
                                <i class="far fa-heart text-2xl"></i>
                                <i class="far fa-comment text-2xl"></i>
                                <i class="far fa-paper-plane text-2xl"></i>
                            </div>
                            <i class="far fa-bookmark text-2xl"></i>
                        </div>

                        <!-- Likes -->
                        <div class="px-3 pb-2 bg-white">
                            <p class="font-semibold text-sm">ì¢‹ì•„ìš” 1,234ê°œ</p>
                        </div>

                        <!-- Caption -->
                        <div id="captionArea" class="px-3 pb-3 bg-white">
                            <p class="text-sm text-gray-400">
                                AIê°€ ìƒì„±í•œ ìº¡ì…˜ê³¼ í•´ì‹œíƒœê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
                            </p>
                        </div>

                        <!-- Comments -->
                        <div class="px-3 pb-3 bg-white border-b border-gray-200">
                            <p class="text-sm text-gray-400">ëŒ“ê¸€ 45ê°œ ëª¨ë‘ ë³´ê¸°</p>
                        </div>

                        <!-- Time -->
                        <div class="px-3 py-2 bg-white">
                            <p class="text-xs text-gray-400">5ë¶„ ì „</p>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settingsModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-key mr-2 text-pink-500"></i>
                    API Key ì„¤ì •
                </h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Google Gemini API Key</label>
                <input type="password" id="apiKeyInput" placeholder="AIza..."
                    class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-pink-500 transition">
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    v1beta ì—”ë“œí¬ì¸íŠ¸ / ê³ í™”ì§ˆ ë‹¤ìš´ë¡œë“œ
                </p>
            </div>

            <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-6">
                <p class="text-sm text-blue-800 mb-2">
                    <i class="fas fa-lightbulb mr-1"></i>
                    Google AI Studioì—ì„œ ë¬´ë£Œë¡œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                </p>
                <a href="https://aistudio.google.com/app/apikey" target="_blank"
                    class="text-sm text-blue-600 hover:underline">
                    â†’ API í‚¤ ë°œê¸‰ë°›ê¸°
                </a>
            </div>

            <button onclick="saveApiKey()"
                class="w-full instagram-gradient text-white font-semibold py-3 rounded-xl hover:shadow-lg transition">
                <i class="fas fa-save mr-2"></i>
                ì €ì¥í•˜ê¸°
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl shadow-2xl p-8 text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-700 font-medium">AIê°€ ë§ˆë²•ì„ ë¶€ë¦¬ëŠ” ì¤‘...</p>
            <p class="text-sm text-gray-500 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” âœ¨</p>
        </div>
    </div>

    <script>
        // Global State
        let images = [];
        let currentImageIndex = 0;
        let logoImage = null;
        let aspectRatio = '1:1';
        let logoPosition = 'bottom-left';
        let logoSize = 20;
        let logoMargin = 3;  // NEW: Logo margin percentage
        let logoOpacity = 80;
        let generatedCaption = '';
        let generatedHashtags = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKey();
            setupDragAndDrop();
            setupLogoInput();
        });

        // Drag & Drop Setup
        function setupDragAndDrop() {
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');

            dropArea.addEventListener('click', () => fileInput.click());

            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('dragover');
            });

            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('dragover');
            });

            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).slice(0, 10);
                handleFiles(files);
            });

            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files).slice(0, 10);
                handleFiles(files);
            });
        }

        // Handle Multiple Files
        async function handleFiles(files) {
            if (files.length === 0) return;

            images = [];
            currentImageIndex = 0;

            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;

                const reader = new FileReader();
                await new Promise((resolve) => {
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            images.push({
                                data: img,
                                base64: e.target.result.split(',')[1],
                                mimeType: file.type,
                                src: e.target.result
                            });
                            resolve();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            if (images.length > 0) {
                showToast(`${images.length}ì¥ì˜ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤ âœ“`, 'success');
                updateThumbnails();
                updateCarousel();
                renderCanvas();
                document.getElementById('downloadBtn').classList.remove('hidden');
            }
        }

        // Update Thumbnails
        function updateThumbnails() {
            const container = document.getElementById('imageThumbnails');
            container.innerHTML = '';
            container.classList.remove('hidden');

            images.forEach((img, index) => {
                const thumb = document.createElement('img');
                thumb.src = img.src;
                thumb.className = 'image-thumbnail' + (index === currentImageIndex ? ' active' : '');
                thumb.onclick = () => {
                    currentImageIndex = index;
                    updateThumbnails();
                    updateCarousel();
                    renderCanvas();
                };
                container.appendChild(thumb);
            });
        }

        // Update Carousel UI
        function updateCarousel() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const dotsContainer = document.getElementById('dotIndicators');

            // Update buttons
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.disabled = currentImageIndex === images.length - 1;

            // Update dots
            dotsContainer.innerHTML = '';
            if (images.length > 1) {
                images.forEach((_, index) => {
                    const dot = document.createElement('div');
                    dot.className = 'dot-indicator' + (index === currentImageIndex ? ' active' : '');
                    dotsContainer.appendChild(dot);
                });
            }
        }

        // Navigation
        function nextImage() {
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                updateThumbnails();
                updateCarousel();
                renderCanvas();
            }
        }

        function prevImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateThumbnails();
                updateCarousel();
                renderCanvas();
            }
        }

        // Aspect Ratio
        function setAspectRatio(ratio) {
            aspectRatio = ratio;

            // Update button styles
            document.querySelectorAll('.aspect-ratio-btn').forEach(btn => {
                btn.className = 'aspect-ratio-btn border-2 border-gray-200 rounded-xl p-4 font-medium transition hover:border-pink-500';
            });
            document.getElementById('ratio-' + ratio.replace(':', '-')).className = 'aspect-ratio-btn border-2 border-pink-500 bg-pink-50 rounded-xl p-4 font-medium transition';

            renderCanvas();
        }

        // Logo Input
        function setupLogoInput() {
            const logoInput = document.getElementById('logoInput');
            logoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        logoImage = img;
                        renderCanvas();
                        showToast('ë¡œê³ ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤ âœ“', 'success');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Logo Position
        function setLogoPosition(position) {
            logoPosition = position;

            document.querySelectorAll('.position-cell').forEach(cell => {
                cell.classList.remove('active');
            });
            document.querySelector(`[data-position="${position}"]`).classList.add('active');

            renderCanvas();
        }

        // Logo Size, Margin & Opacity
        function updateLogoSize(value) {
            logoSize = parseInt(value);
            document.getElementById('logoSizeValue').textContent = value;
            renderCanvas();
        }

        function updateLogoMargin(value) {
            logoMargin = parseInt(value);
            document.getElementById('logoMarginValue').textContent = value;
            renderCanvas();
        }

        function updateLogoOpacity(value) {
            logoOpacity = parseInt(value);
            document.getElementById('logoOpacityValue').textContent = value;
            renderCanvas();
        }

        // ===== HIGH-RESOLUTION CANVAS RENDERING (v5.0 FIX!) =====
        function renderCanvas() {
            if (images.length === 0) return;

            const canvas = document.getElementById('editCanvas');
            const ctx = canvas.getContext('2d');
            const img = images[currentImageIndex].data;

            // Get original image dimensions
            const naturalW = img.naturalWidth;
            const naturalH = img.naturalHeight;

            // Calculate crop area based on aspect ratio (CENTER CROP)
            let sx, sy, sWidth, sHeight;

            if (aspectRatio === '1:1') {
                // Square: crop to shortest side, centered
                const size = Math.min(naturalW, naturalH);
                sWidth = sHeight = size;
                sx = (naturalW - size) / 2;
                sy = (naturalH - size) / 2;
            } else if (aspectRatio === '4:5') {
                // 4:5 ratio: calculate based on image orientation, centered
                const targetRatio = 4 / 5;
                const imgRatio = naturalW / naturalH;

                if (imgRatio > targetRatio) {
                    // Image is wider than 4:5, crop width
                    sHeight = naturalH;
                    sWidth = sHeight * targetRatio;
                    sx = (naturalW - sWidth) / 2;
                    sy = 0;
                } else {
                    // Image is taller than 4:5, crop height
                    sWidth = naturalW;
                    sHeight = sWidth / targetRatio;
                    sx = 0;
                    sy = (naturalH - sHeight) / 2;
                }
            } else {
                // Original: use full image
                sx = sy = 0;
                sWidth = naturalW;
                sHeight = naturalH;
            }

            // Set Canvas size to cropped dimensions (ORIGINAL RESOLUTION!)
            canvas.width = sWidth;
            canvas.height = sHeight;

            // Clear canvas
            ctx.clearRect(0, 0, sWidth, sHeight);

            // Draw cropped image at full resolution
            ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);

            // Draw logo overlay (if exists)
            if (logoImage) {
                // Calculate logo size based on canvas width (maintains resolution)
                const logoWidth = canvas.width * (logoSize / 100);
                const logoHeight = (logoImage.height / logoImage.width) * logoWidth;

                // Calculate margin based on canvas size
                const padding = canvas.width * (logoMargin / 100);

                // Calculate logo position
                let logoX, logoY;

                const positions = {
                    'top-left': [padding, padding],
                    'top-center': [(canvas.width - logoWidth) / 2, padding],
                    'top-right': [canvas.width - logoWidth - padding, padding],
                    'middle-left': [padding, (canvas.height - logoHeight) / 2],
                    'middle-center': [(canvas.width - logoWidth) / 2, (canvas.height - logoHeight) / 2],
                    'middle-right': [canvas.width - logoWidth - padding, (canvas.height - logoHeight) / 2],
                    'bottom-left': [padding, canvas.height - logoHeight - padding],
                    'bottom-center': [(canvas.width - logoWidth) / 2, canvas.height - logoHeight - padding],
                    'bottom-right': [canvas.width - logoWidth - padding, canvas.height - logoHeight - padding]
                };

                [logoX, logoY] = positions[logoPosition];

                // Apply opacity and draw logo
                ctx.globalAlpha = logoOpacity / 100;
                ctx.drawImage(logoImage, logoX, logoY, logoWidth, logoHeight);
                ctx.globalAlpha = 1.0;
            }
        }

        // Generate Caption with Gemini API (v1beta)
        async function generateCaption() {
            const apiKey = getApiKey();
            if (!apiKey) {
                showToast('ë¨¼ì € API Keyë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”', 'error');
                openSettings();
                return;
            }

            if (images.length === 0) {
                showToast('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            showLoading();

            try {
                // Prepare images (max 3)
                const imagesToSend = images.slice(0, 3).map(img => ({
                    inline_data: {
                        mime_type: img.mimeType,
                        data: img.base64
                    }
                }));

                // Build prompt
                const prompt = images.length > 1
                    ? "ì´ ì—¬ëŸ¬ ì¥ì˜ ì‚¬ì§„ë“¤ì„ ë³´ê³ , ì „ì²´ì ì¸ ë¶„ìœ„ê¸°ë¥¼ ì•„ìš°ë¥´ëŠ” ê°ì„±ì ì¸ ì¸ìŠ¤íƒ€ê·¸ë¨ ìº¡ì…˜ 1ê°œì™€ ìœ ì…ì„ ë¶€ë¥´ëŠ” í•´ì‹œíƒœê·¸ 25ê°œë¥¼ ì‘ì„±í•´ì¤˜. ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì¤˜:\n{\"caption\": \"ìº¡ì…˜ ë‚´ìš©\", \"hashtags\": \"#íƒœê·¸1 #íƒœê·¸2 ...\"}"
                    : "ì´ ì‚¬ì§„ì„ ë³´ê³  ê°ì„±ì ì¸ ì¸ìŠ¤íƒ€ê·¸ë¨ ìº¡ì…˜ 1ê°œì™€ ìœ ì…ì„ ë¶€ë¥´ëŠ” í•´ì‹œíƒœê·¸ 25ê°œë¥¼ ì‘ì„±í•´ì¤˜. ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì¤˜:\n{\"caption\": \"ìº¡ì…˜ ë‚´ìš©\", \"hashtags\": \"#íƒœê·¸1 #íƒœê·¸2 ...\"}";

                // Call Gemini API (v1beta - CORRECT ENDPOINT)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                ...imagesToSend
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error Response:', errorData);
                    console.error('Status:', response.status, response.statusText);

                    let errorMessage = 'API ì˜¤ë¥˜';
                    if (response.status === 400) {
                        errorMessage = 'API Keyê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    } else if (response.status === 429) {
                        errorMessage = 'API í• ë‹¹ëŸ‰ ì´ˆê³¼. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    } else if (response.status === 403) {
                        errorMessage = 'API Key ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. Keyë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    } else if (errorData.error?.message) {
                        errorMessage = errorData.error.message;
                    }

                    throw new Error(errorMessage);
                }

                const data = await response.json();

                if (!data.candidates || !data.candidates[0]) {
                    throw new Error('API ì‘ë‹µì— ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
                }

                const text = data.candidates[0].content.parts[0].text;

                // Parse JSON
                let jsonMatch = text.match(/\{[\s\S]*\}/);

                if (!jsonMatch) {
                    const codeBlockMatch = text.match(/```(?:json)?\s*\n?([\s\S]*?)```/);
                    if (codeBlockMatch) {
                        jsonMatch = codeBlockMatch[1].match(/\{[\s\S]*\}/);
                    }
                }

                if (!jsonMatch) {
                    console.error('Raw API response:', text);
                    throw new Error('JSON í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                const result = JSON.parse(jsonMatch[0]);

                if (!result.caption || !result.hashtags) {
                    throw new Error('ì‘ë‹µì— í•„ìˆ˜ í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤');
                }

                generatedCaption = result.caption;
                generatedHashtags = result.hashtags;

                updateCaptionDisplay(result.caption, result.hashtags);

                hideLoading();
                showToast('ìƒì„± ì™„ë£Œ! ğŸ‰', 'success');

            } catch (error) {
                hideLoading();
                console.error('======= ì—ëŸ¬ ë°œìƒ =======');
                console.error('Error:', error);
                console.error('Error Message:', error.message);
                console.error('=========================');

                let userMessage = 'ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

                if (error.message.includes('API Key')) {
                    userMessage = error.message;
                } else if (error.message.includes('API ì˜¤ë¥˜') || error.message.includes('í• ë‹¹ëŸ‰')) {
                    userMessage = error.message;
                } else if (error.message.includes('JSON')) {
                    userMessage = 'AI ì‘ë‹µ ì²˜ë¦¬ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (F12 ì½˜ì†” í™•ì¸)';
                } else if (error.message.includes('candidates')) {
                    userMessage = 'AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë‚˜ ì„¤ì •ì„ ë³€ê²½í•´ë³´ì„¸ìš”.';
                } else {
                    userMessage = error.message + ' (F12 ì½˜ì†” í™•ì¸)';
                }

                showToast(userMessage, 'error');
            }
        }

        // Update Caption Display
        function updateCaptionDisplay(caption, hashtags) {
            const captionArea = document.getElementById('captionArea');
            captionArea.innerHTML = `
                <p class="text-sm">
                    <span class="font-semibold">InstaPlanner</span>
                    <span class="ml-1">${caption}</span>
                </p>
                <p class="text-sm text-blue-600 mt-2">${hashtags}</p>
            `;
        }

        // ===== HIGH-QUALITY DOWNLOAD (v5.0 FIX!) =====
        function downloadCurrentImage() {
            if (images.length === 0) return;

            const canvas = document.getElementById('editCanvas');
            const link = document.createElement('a');
            link.download = `insta-feed-highres-${currentImageIndex + 1}.jpg`;

            // Use JPEG with maximum quality (1.0)
            link.href = canvas.toDataURL('image/jpeg', 1.0);
            link.click();

            showToast('ê³ í™”ì§ˆ ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤ âœ“', 'success');
        }

        // Settings Modal
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showToast('API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            localStorage.setItem('gemini_api_key', apiKey);
            showToast('API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“', 'success');
            closeSettings();
        }

        function loadApiKey() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (apiKey) {
                document.getElementById('apiKeyInput').value = apiKey;
            }
        }

        function getApiKey() {
            return localStorage.getItem('gemini_api_key');
        }

        // Loading Overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Toast Notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';

            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            const color = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : 'text-blue-400';

            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas ${icon} ${color}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>

</body>

</html>